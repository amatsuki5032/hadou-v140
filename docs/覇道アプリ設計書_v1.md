# 三國志覇道 アプリ設計書 v1

> **更新日:** 2026-02-13（v1.50+反映）
> **対象:** v150 編制管理アプリ  
> **関連:** 覇道DB定義書_v3（データ構造）、覇道ルール定義書（ゲーム仕様）

---

## 1. アーキテクチャ

```
┌───────────────────────┐          ┌──────────────────────────┐
│  Excel (原本)          │  ETL     │  JS (GitHub Pages)        │
│  覇道DB.xlsx          │ ──────→  │  data-generals.js         │
│  覇道DB_武将_.xlsx     │          │  data-all-treasures.js    │
│  覇道DB_名宝_.xlsx     │          │  data-skill-db.js         │
└───────────────────────┘          │  data-research.js         │
                                   │  data-survey.js           │
                                   │  data-horse-skills.js     │
                                   │  data-treasure-forge.js   │
                                   └────────┬───────────────────┘
                                            │ <script defer> tags
                                   ┌────────▼──────────────────┐
                                   │  Web App (vanilla JS)       │
                                   │  ├── index.html             │
                                   │  ├── app.js                 │
                                   │  ├── calc-engine.js         │
                                   │  ├── stat-calculator.js     │
                                   │  ├── skill-conditions.js    │
                                   │  ├── data-profile.js        │
                                   │  ├── config.js              │
                                   │  ├── utils.js               │
                                   │  ├── components-panels.js   │
                                   │  ├── components-modals.js   │
                                   │  ├── components-formations.js│
                                   │  ├── components-rank.js     │
                                   │  ├── components-profile.js  │
                                   │  ├── handlers-dnd.js        │
                                   │  ├── data-io.js             │
                                   │  ├── firebase-sync-addon.js │
                                   │  ├── handlers-template.js   │
                                   │  ├── updateHistory.js       │
                                   │  └── styles.css             │
                                   │          │                   │
                                   │  ┌──────▼────────────┐      │
                                   │  │ Firebase Auth      │      │
                                   │  │ + Firestore        │      │
                                   │  │ (ユーザー編制)      │      │
                                   │  └───────────────────┘      │
                                   └──────────────────────────────┘
```

**技術スタック:** vanilla JS（ビルドツールなし）、Firebase、GitHub Pages
**デザインテーマ:** 「雨夜の月」（ダーク系）

---

## 2. データ統合方針

### 現状（統合済み + 旧ファイル残存）

```
SKILL_DB          （1,783技能）── 自動生成、calc-engine.jsが参照 ✅
RESEARCH_DATA     （127件）  ── 自動生成 ✅
SURVEY_DATA                  ── 自動生成 ✅
HORSE_SKILLS_DATA            ── 自動生成 ✅
TREASURE_FORGE               ── 自動生成 ✅（187/209件の鍛錬データ）
```

### 統合計画（段階的）

```
Phase 1: ✅ 完了 — SKILL_DBを<script>で追加、calc-engine.jsをSKILL_DB参照に書き換え
Phase 2: ✅ 完了 — 旧2ファイルを削除（参照なし確認済み、ファイル・scriptタグ削除済み）
Phase 3: プロファイルシステム実装（研究/調査/軍馬） — ✅ 完了
```

---

## 3. Firebase編制データ設計

```javascript
// Firestore: users/{uid}/formations/{formationId}
{
  name: "第一部隊",
  formation_id: "歩兵陣",

  // メインスロット
  main:     { general_id: 1,   equipment: { weapon: null, armor: null, accessory: null } },
  sub1:     { general_id: 101, equipment: { weapon: null, armor: null, accessory: null } },
  sub2:     { general_id: 102, equipment: { weapon: null, armor: null, accessory: null } },
  advisor1: { general_id: 103, equipment: { weapon: null, armor: null, accessory: null } },
  advisor2: { general_id: 104, equipment: { weapon: null, armor: null, accessory: null } },

  // 侍従（最大4、陣形依存）
  attendants: [
    { general_id: 201, position: "左" },
    { general_id: 202, position: "右上" }
  ],

  // 参軍（5枠）
  sanjun: { command: null, force: null, intellect: null, politics: null, charm: null },

  // 兵器・武装
  siege_weapon: null,
  armament: null,

  // メタ
  tags: ["PvP", "メイン"],
  created_at: serverTimestamp(),
  updated_at: serverTimestamp(),
}
```

---

## 4. 実装チェックリスト

### Phase 1: データファイル整備
```
[✅] 覇道DB.xlsx 新9列追加（17個別シート）
[✅] Power Query更新（列名標準化、フィルタ簡略化）
[✅] 技能DB統合ビュー動作確認（5,733行×39列）
[✅] data-skill-db.js 生成（1,783技能）
[✅] data-skill-db.js をindex.htmlに組み込み
[✅] calc-engine.js をSKILL_DB参照に書き換え
[✅] skill-conditions.js 作成（44パターンの発動条件評価）
[✅] stat-calculator.js 作成（天賦テーブル・陣形反映率・ステータス計算）
[✅] data-research.js 生成（127件、M/専攻分類付き）
[✅] 旧data-skill-effects.js / data-combat-parameters.js 廃止（参照なし確認済み、ファイル削除済み）
```

### Phase 2: ETL自動化
```
[✅] ETLスクリプト作成（覇道DB.xlsx → data-skill-db.js）— tools/etl_skill_db.py
[✅] 武将データETL（覇道DB_武将_.xlsx → data-generals.js 統合済み）— 政治/魅力/性別/五行追加・5ファイル→1ファイル統合
[✅] 名宝鍛錬データETL（覇道DB_名宝_.xlsx → data-treasure-forge.js）— tools/etl_treasures_forge.py
[✅] バリデーション（武将技能リンク、ID一意性）— tools/validate_data.py
[ ] ETLパイプライン自動化（手動実行→スクリプト化）
```

### Phase 3: Firebase編制保存
```
[ ] Firestoreスキーマの実装
[ ] 編制保存/読込のCRUD
[ ] セキュリティルールの設定
```

### Phase 4: プロファイルシステム（v1.50で実装完了）
```
[✅] ProfilePanel UI実装（研究/調査/軍馬タブ）— ランク設定UIと統合済み
[✅] 研究タブ: 専攻選択 + 項目入力（127件）— isMaster判定・第4枠→特化戦術リネーム修正済み
[✅] 調査タブ: レベル選択（23件）— UI設計完了、実装済み
[✅] 軍馬タブ: 3頭編制 + 毛色/名馬/技能設定 — 実装済み
[✅] localStorage保存（hadou-profile）
[✅] stat-calculator.js統合（調査・軍馬の効果を部隊ステータスに反映）
[✅] stat-calculator.js統合（研究の効果→部隊ステータス反映）— ユーザー入力%値を基礎ステータスに反映（calcResearchBonuses）
```

### Phase 5: ステータス計算システム完全化（設計済み・未実装）

8つの不足システムを段階的に実装する。

```
[✅] ① 参軍ステータス加算 — stat-calculator.js の calcAdvisorContribution() で実装済み。app.js:1252 で level:10 固定で呼び出し
[✅] ② 名宝ステータス加算 — calc-engine.js の buildAllEntries() + collectTreasureSkillEntries() で実装済み。☆0・通常固定。EMBEDDED_TREASURES_DATA→TREASURE_FORGE のIDマッピングは技能名セット一致で解決
[ ] ③ 兵科レベル — 優先度:中。データ無（ユーザー入力式）
[ ] ④ SSR/SR/R基礎ステータス — 優先度:中。武将DBに値0。Excel入力 or ユーザー入力
[ ] ⑤ 研究レベル別効果値 — 優先度:中。DB無（ユーザー入力式）。プロファイル研究タブと連動
[✅] ⑥ 陣形固有効果 — stat-calculator.js の FORMATION_STAT_BONUSES + calcFormationBonuses() で実装。兵科人数/好相性人数条件付き%ボーナス（9陣形・4効果タイプ）。levels=null の定性効果はスキップ
[ ] ⑦ 都市権利・インフラ — 優先度:低。施政/特産/インフラの設計書作成済み
[ ] ⑧ 武装システム — 優先度:低。12種・3効果源（武装効果/配備武将技能/錬磨役技能）
```

### Phase 6: 武将育成プロファイル（設計済み・未実装）

武将個別の育成状態を管理する。

```
[ ] profileData構造拡張: generalProfiles[generalId] = { level, grade, starRank, elements, advisorLevel }
[ ] calcActualStatリファクタリング（後方互換維持）
[ ] UI: サブタブ方式（☆/Lv/Grade、五行、参軍レベル）
[ ] 確認済み仕様: グレード上限30、レベル上限50/60、五行0-20、参軍レベル0-10
```

---

## 5. リファクタリング・リリース実績

### app.js分割（2026-02-07〜08）

| ファイル | 行数 | 責務 |
|---------|------|------|
| app.js | ~2,550 | メインアプリ（state管理・レンダリング） |
| components-panels.js | ~1,500 | GeneralsPanel, TreasuresPanel |
| components-modals.js | ~1,100 | 6つのモーダルコンポーネント |
| components-formations.js | ~1,160 | 編制パネル（ステータス表示・パラメータ・技能別内訳） |
| components-rank.js | ~940 | 武将育成プロファイルUI（Lv/Grade/☆）・技能一覧トグル |
| components-profile.js | ~800 | 研究/調査/軍馬タブUI |
| handlers-dnd.js | ~600 | ドラッグ&ドロップハンドラ（factory pattern） |
| data-io.js | ~500 | データ入出力（JSON エクスポート/インポート）（factory pattern） |
| firebase-sync-addon.js | ~120 | Firebase自動同期（localStorage⇔Firestore リアルタイム同期） |
| handlers-template.js | ~300 | テンプレート管理（factory pattern） |
| data-profile.js | ~200 | プロファイルデータ管理・localStorage |
| config.js | ~50 | 設定定数 |
| utils.js | ~340 | 共通ユーティリティ（generalMap含む） |
| updateHistory.js | ~100 | 更新履歴表示 |

旧app.js: 7,081行 → 分割後: ~2,550行（**-64%**）

### v1.45 データ統合（2026-02-10）

- 武将データ5ファイル → data-generals.js 1ファイルに統合
- LR/URの全ステータス・五行・政治・魅力・性別データ反映
- LR 92名（荀攸・項籍追加）、UR 108名（鄒氏追加）、全ステータス入力完了

### v1.50 プロファイルシステム（2026-02-10）

- 研究/調査/軍馬タブ実装（ランク設定UIと統合）
- 名宝おススメシステム（全カテゴリ展開・異民族マッチング・練達マッチング）
- 配置済みアイテムのドラッグ再配置対応
- クリック選択→クリック配置（遠隔移動）対応
- 武将育成プロファイルUI（Level/Grade/☆ランク設定）
- data-treasure-forge.js生成（名宝鍛錬データ187/209件）
- 調査・軍馬の効果をstat-calculatorに統合（ステータス計算に反映）
- ステータス内訳表示トグル（「内訳 ▼/▲」ボタン）

### v1.50+ 修正・改善（2026-02-11）

- SSR以下ダブルクリック → 参軍配置（侍従ではなく参軍枠に配置）
- 名宝クリック移動で異カテゴリ間移動を防止
- 武将削除処理に参軍からの削除を追加
- index.html パフォーマンス改善（defer追加、CSS優先読み込み、ローディング表示）
- 名宝ステータス加算実装（buildAllEntries / collectTreasureSkillEntries）☆0・通常固定
- 武将技能+名宝技能の統合計算（付与効果含む）
- 内訳表示に「名宝」ラベル追加
- 研究効果のステータス反映接続（calcResearchBonuses → stat-calculator統合、内訳に「研究」ラベル追加）
- 陣形固有効果の計算反映（FORMATION_STAT_BONUSES + calcFormationBonuses → stat-calculator統合、内訳に「陣形」ラベル追加）
- 一括変更ボタンにconfirm警告を追加（誤操作防止）
- 技能一覧表示トグルボタンを追加（部隊カード内で技能一覧の表示/非表示切り替え）
- 練達効果の実装（名宝技能→武将技能Lvアップをcalc-engine.jsで計算）
- 練達の適用タイミング修正（付与解決後に移動）
- 技能効果パネルに技能別内訳表示を追加（components-formations.js）
- 内訳パネルに戦闘パラメータの技能別内訳を表示
- ステータスパネルをフルワイド化・フォントサイズ拡大
- 武将ID検索のO(1)化（utils.js にgeneralMap導入）

### 修正済みバグ

- useState lazy init競合（プロファイルデータ消失の原因）
- 未定義変数参照（factory抽出時のインポート漏れ）
- 諸葛恪の相性値修正（126→121）
- 半角カタカナ修正（data-generals.js生成時）
- LR関銀屏の性別修正（男→女）
- 参軍からの武将削除漏れ（handleGeneralDoubleClick / moveToDisabled）

---

## 6. 武将データ入力率

| シート | 入力率 | 備考 |
|--------|--------|------|
| LRDB | 92/92 (100%) | ✅ 完了（荀攸・項籍追加、全ステータス入力済み） |
| URDB | 108/108 (100%) | ✅ 完了（鄒氏追加、全ステータス入力済み） |
| SSR800DB | 45/50 (90%) | 残5名（異民族系） |
| SSR850DB | 0/66 | 未着手 |
| SSR875DB | 0/14 | 未着手 |
| SSR900DB | 0/17 | 未着手 |
| SRRNDB | 0/101 | 未着手（侍従用途では不要だが将来計算で必要） |

**JS化済み:** data-generals.js に全447名を統合（v1.45）。LR/URはステータス・五行・政治・魅力完備。SSR以下はステータス0。

---

## 7. ユーティリティツール・補助ファイル

### 7.1 アイコン不足チェッカー（icon-checker.html）

リポジトリルート（index.htmlと同階層）に配置。

- data-generals.js / data-all-treasures.js を `<script>` で動的読み込み
- 武将アイコン: `./icons/generals/{rarity}/{rarity}{name}.png`
- 名宝アイコン（通常）: `./icons/treasures/normal/{name}.png`
- 名宝アイコン（UR）: `./icons/treasures/UR/UR{name}.png`
- データファイル更新時、チェッカー自体の修正は不要
- 「不足リストをコピー」でファイル名一覧をクリップボードに出力可能
- URL: `https://amatsuki5032.github.io/hadou-v140/icon-checker.html`

### 7.2 ETLツール（tools/）

`tools/` ディレクトリに配置。Python 3 + openpyxl が必要。
Claude.ai / Claude Code で生成したスクリプト群。

#### etl_skill_db.py — 技能DB → JSファイル生成

覇道DB.xlsx の技能DBシート（Power Query統合ビュー）を読み込み、`data-skill-db.js` を生成する。

```bash
# 前提: pip install openpyxl
python tools/etl_skill_db.py 覇道DB.xlsx data-skill-db.js
```

- 読込仕様: 行1=情報行（スキップ）、行2=テーブルヘッダー（39列）、行3〜=データ
- 技能名でグループ化、所持行（種類2='所持'）を分離、分析9列を付与
- 出力: `const SKILL_DB = { ... };` 形式のJSファイル
- 統計表示: 技能数・効果行数・ソース別内訳をコンソール出力

#### etl_treasures_forge.py — 名宝鍛錬 → JSファイル生成

覇道DB_名宝_.xlsx の名宝一覧シート + 鍛錬シートを読み込み、`data-treasure-forge.js` を生成する。

```bash
python tools/etl_treasures_forge.py 覇道DB_名宝_.xlsx data-treasure-forge.js
```

- 名宝一覧シート: 行1=ヘッダー、行2〜=データ（209件）
- 鍛錬シート: 行1=ヘッダー、行2〜=データ（1,030行）
- 段階（通常/UR）と☆ランク別の技能レベル（☆0〜★10）を統合
- 出力: `const TREASURE_FORGE = { ... };` 形式のJSファイル
- 統計表示: 名宝数・鍛錬データあり件数をコンソール出力

#### validate_data.py — データ整合性チェック

3つのExcelファイルを横断してデータ整合性を検証する。

```bash
python tools/validate_data.py 覇道DB.xlsx 覇道DB_武将_.xlsx 覇道DB_名宝_.xlsx
```

チェック項目:

| # | 検証内容 | 説明 |
|---|---------|------|
| 1 | 武将IDの一意性 | レアリティ横断でID重複がないか |
| 2 | 武将技能→技能DBリンク | 武将技能シートの技能名が技能DBに存在するか |
| 3 | 名宝技能→技能DBリンク | 名宝一覧の技能名が技能DB・名宝シートに存在するか |
| 4 | 名宝ID衝突 | 名宝シート内で同一IDに異なる武器が割り当てられていないか |
| 5 | 鍛錬↔名宝一覧整合性 | 鍛錬シートのIDが名宝一覧に存在するか（逆方向も） |

- 結果は ✅（OK）/ ⚠️（警告）/ ❌（エラー）で表示
- 最後に「エラー N件 / 警告 N件」のサマリーを出力

### 7.3 Firebase自動同期（firebase-sync-addon.js）

リポジトリルート（index.htmlと同階層）に配置。
data-io.js（手動エクスポート/インポート）とは別の責務。

- **役割:** localStorage の変更を自動的にFirestore（hadou-dataコレクション）に保存し、他デバイスからの変更をリアルタイム検知する
- **仕組み:** `localStorage.setItem` をフック（Proxy）し、保存時に500msデバウンスでFirebaseへ書き込み
- **セッションID:** 自分自身の更新を検知しないよう、各セッションに固有IDを付与
- **競合解決:** lastUpdatedタイムスタンプの比較。他デバイスの更新が新しければ確認ダイアログ→リロード
- **依存:** `FirebaseSync` オブジェクト（firebase-config.js で定義）

| ファイル | 役割 |
|---------|------|
| data-io.js | 手動のJSON エクスポート/インポート（ファイルDL/アップロード） |
| firebase-sync-addon.js | 自動のlocalStorage⇔Firestore リアルタイム同期 |

### 7.4 CLAUDE.md

リポジトリルートに配置。Claude Code 用のプロジェクト設定ファイル。
Claude Code がリポジトリを操作する際のコンテキスト情報を提供する。
アプリの動作には影響しない。

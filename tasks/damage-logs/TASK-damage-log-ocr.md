# タスク: ダメージログ スクリーンショット一括解析

## 概要

`tasks/damage-logs/` 配下の部隊別フォルダに配置されたスクリーンショット画像を `view` コマンドで読み取り、戦闘ログのテキストを抽出してCSVファイルに出力する。

**OCRは使わない。** Claude Code の画像認識（view）で直接テキストを読み取る。

---

## 処理設計

1セッションで全フォルダを順番に処理する。各部隊のログは独立しているため、フォルダ間でステートは引き継がない。

### フォルダ構造

```
tasks/damage-logs/
├── TASK.md               ← このファイル（全セッション共通で参照）
├── kouki/                ← セッション1: 項籍隊
│   ├── *.png
│   ├── progress.json
│   └── result.csv
├── enshou/               ← セッション2: 袁紹隊
│   ├── *.png
│   ├── progress.json
│   └── result.csv
├── sousou/               ← セッション3: 曹操隊
│   ├── *.png
│   ├── progress.json
│   └── result.csv
├── ryubi/                ← セッション4: 劉備隊
│   ├── *.png
│   ├── progress.json
│   └── result.csv
├── sonken/               ← セッション5: 孫権隊
│   ├── *.png
│   ├── progress.json
│   └── result.csv
├── merged-result.csv     ← 全部隊統合CSV
└── damage-report.xlsx    ← 集計レポート（マージ時に生成）
```

フォルダ名は主将名のローマ字を推奨。任意の名前でOK。

### 準備手順（ユーザーが実施）

1. ゲーム内の絞り込み機能で部隊を選択してスクショを撮る
2. 部隊（主将名）ごとにフォルダを作り、スクショを配置
3. 各フォルダ内の画像はタイムスタンプ順にソートされるファイル名にする

### CCの起動

以下のオプションで起動する。全操作が確認なしで自動実行される。

```bash
claude --dangerously-skip-permissions
```

### 指示（1行でOK）

```
tasks/damage-logs/TASK.md を読んで全フォルダを処理して
```

これだけで以下が自動実行される:
1. `tasks/damage-logs/` 直下のサブフォルダを自動検出（TASK.md、merged-result.csv、damage-report.xlsx は除外）
2. フォルダ名のアルファベット順に1フォルダずつ処理
3. 各フォルダに progress.json があれば途中再開、完了済み（全画像processed）ならスキップ
4. 全フォルダ完了後、自動でマージ＆Excel出力を実行

### 特定フォルダだけ処理したい場合

```
tasks/damage-logs/TASK.md を読んで kouki を処理して
```

### compact後の再開

```
tasks/damage-logs/TASK.md を読んで全フォルダを処理して
```

同じ指示でOK。完了済みフォルダは自動スキップされる。

---

## ⚠ compact対応設計

各フォルダ内でコンテキストが膨張した場合の対策。

### 進捗管理ファイル

各フォルダの **`progress.json`** に処理状態を毎回保存する。

```json
{
  "folder": "kouki",
  "total": 50,
  "processed": ["img001.png", "img002.png", "img003.png"],
  "failed": [],
  "last_state": {
    "squad_name": "項籍隊",
    "hp": "24353",
    "attacker": "項籍",
    "tactic": "抜山蓋世",
    "is_tactic_context": true
  }
}
```

### 処理ルール

1. **起動時・compact復帰時ともに、まずこのタスクファイルを読み直す。** 次に対象フォルダの progress.json を読む。存在すれば途中再開、なければ新規開始。
2. **画像1枚の処理が終わるたびに result.csv にappend + progress.json を更新する。**
3. **CSVはヘッダー行つきで初回作成し、以降はデータ行のみappend。**
4. **compact後の再開:** 同じ指示「`tasks/damage-logs/TASK.md` を読んで全フォルダを処理して」でOK。完了済みフォルダとprocessed画像は自動スキップされる。
5. **全画像完了後にサマリーを表示する。** progress.json は残す。

### compact発動タイミング

- **5〜10枚処理するごとに自発的にcompactする。** ユーザーの指示を待たない。
- compact前に必ず progress.json と result.csv を書き出してから compact する。

---

## 作業フロー

### 全フォルダ処理モード

```
1. tasks/damage-logs/ 直下のサブフォルダ一覧を取得（ファイルは除外）
2. フォルダ名のアルファベット順にソート
3. 各フォルダに対して:
   a. progress.json を確認し、全画像がprocessed済みならスキップ
   b. 未完了なら「1フォルダ分の処理」を実行
   c. フォルダ完了後、次のフォルダへ
4. 全フォルダ完了後、マージ＆Excel出力を自動実行
```

### 1フォルダ分の処理

```
1. 指定されたフォルダ内の画像ファイル一覧を取得（*.png, *.jpg, *.jpeg）
2. ファイル名の自然順ソート（タイムスタンプ順を維持）
3. progress.json があれば読み込み、processed に含まれるファイルをスキップ
4. 未処理の各画像に対して:
   a. view コマンドで画像を表示・読み取り
   b. パースルールに従ってCSV行を生成
   c. result.csv にappend（bashでecho追記）
   d. progress.json を更新（bashでファイル書き出し）
   e. 5〜10枚ごとにcompact判断
5. 全画像完了後にサマリー表示
```

---

## 画像の読み取り指示

各スクリーンショットには三國志覇道の戦闘ログが表示されている。
ログは暗い半透明背景の上に、以下の色で文字が表示される:

- **白文字**: 部隊名、「が攻撃」、「の損害」等の通常テキスト
- **赤文字（部隊名の一部）**: 武将名のハイライト
- **黄色文字**: 損害値（ダメージ数字）、「城壁」等の対象名
- **緑文字**: 「会心」「撃心」

**読み取り時の注意:**
- 画像内のすべてのログ行を上から下に順番に読み取る
- 数字は正確に読む（特に桁数に注意、7桁以上の数値あり）
- 括弧内の数字（兵力）も正確に
- 「会心」「撃心」の区別を正確に
- 画像の上端・下端で切れている行は読み取れる範囲で読む（不完全な行はスキップ可）

---

## パースルール

### 抽出対象パターン

**パターン1: 通常攻撃の開始**
```
「○○隊（数字）が攻撃」
例: 「項籍隊（23932）が攻撃」
→ 部隊名=項籍隊, 兵力=23932 を記憶（後続のダメージ行に紐づける）
→ 発動者・戦法名をクリア（is_tactic_context = false）
```

**パターン2: ダメージ行（城壁のみ抽出）**
```
「城壁に9638の損害」           → 種別=通常（is_tactic_context=falseの場合）
「城壁に2694534の損害（会心）」 → 種別=会心
「城壁に10958955の損害（撃心）」→ 種別=撃心
「城壁に2383917の損害」        → 種別=戦法（is_tactic_context=trueの場合）
```
- 「城壁」以外（例:「洛陽歩兵に54262の損害」「洛陽騎兵に430466の損害」「洛陽弓兵に449017の損害」）はスキップ
- 会心/撃心は is_tactic_context に関わらず会心/撃心として出力

**パターン3: 戦法発動（自部隊）**
```
「○○隊（数字）の○○が戦法「○○」を発動」
例: 「項籍隊（23904）の孫尚香が戦法「風虎佳烈」を発動」
例: 「項籍隊（24353）の程普が戦法「練武修文」を発動」
→ 部隊名, 兵力, 発動者, 戦法名を記憶
→ is_tactic_context = true
```
- 戦法発動後にダメージ行がない場合がある（バフ系戦法等）

**パターン4: 連鎖戦法**
```
「続けて○○が戦法「○○」を発動」
例: 「続けて程普が戦法「練武修文」を発動」
例: 「続けて項籍が戦法「抜山蓋世」を発動」
→ 発動者・戦法名を更新（部隊名・兵力は直前を引き継ぐ）
→ is_tactic_context = true
```
- 連鎖回数は可変（2連鎖〜3連鎖を確認済み）

### スキップ対象

**他プレイヤーの行:**
```
「あおりくの劉備隊の劉備が戦法「英風弘烈」を発動」
```
→ 判定: 「○○の○○隊」形式（隊の前にプレイヤー名+「の」がある）

**自部隊の行動通知（ダメージ情報なし）:**
```
「あまつきの項籍隊が行動」
```
→ パターン1〜4のどれにもマッチしないため自然にスキップ

**城壁以外のダメージ:**
```
「洛陽歩兵に54262の損害」
「洛陽騎兵に430466の損害（会心）」
「洛陽弓兵に449017の損害（会心）」
```
→ 対象が「城壁」でなければスキップ

### ステートマシン

```
初期状態
  → [攻撃開始] → 部隊名・兵力を記憶、is_tactic_context=false
  → [ダメージ行(城壁)] → CSV行出力（種別=通常 or 会心 or 撃心）
  → [戦法発動] → 部隊名・兵力・発動者・戦法名を記憶、is_tactic_context=true
  → [ダメージ行(城壁)] → CSV行出力（種別=戦法 or 会心 or 撃心、発動者・戦法名付き）
  → [連鎖戦法] → 発動者・戦法名を更新（部隊名・兵力は引き継ぎ）、is_tactic_context=true
  → [ダメージ行(城壁)] → CSV行出力（連鎖戦法ダメージ）
  → [次の攻撃開始] → ステートリセット
```

**戦法→ダメージ行がない場合:**
- 戦法発動後にダメージ行が来ずに別の戦法や攻撃が来た場合、前の戦法のCSV行は出力しない
- 発動者・戦法名を新しいものに上書き

**画像をまたぐ状態引き継ぎ:**
- progress.json の `last_state` に現在のステートを保存し、次の画像で復元

---

## CSV出力フォーマット

**ファイル:** 各フォルダの `result.csv`（UTF-8 BOM付き、Excel対応）

```csv
画像,部隊名,兵力,対象,損害値,種別,発動者,戦法名
img001.png,項籍隊,28372,城壁,1906,通常,,
img001.png,項籍隊,28372,城壁,3774,通常,,
img002.png,項籍隊,25307,城壁,744224,戦法,程普,練武修文
img002.png,項籍隊,25307,城壁,2890187,戦法,項籍,抜山蓋世
img003.png,項籍隊,25307,城壁,3020380,会心,,
```

**種別の判定ロジック:**
1. ダメージ行に（会心）がある → **会心**（発動者・戦法名は空にする）
2. ダメージ行に（撃心）がある → **撃心**（発動者・戦法名は空にする）
3. is_tactic_context=true かつ 会心/撃心でない → **戦法**（発動者・戦法名を出力）
4. is_tactic_context=false かつ 会心/撃心でない → **通常**（発動者・戦法名は空）

---

## マージ＆Excel出力

全部隊のCSV処理が完了した後、以下の手順でExcelレポートを生成する。

### 指示

```
「tasks/damage-logs/TASK.md を読んでマージ＆Excel出力を実行して」
```

### 処理手順

1. `tasks/damage-logs/*/result.csv` を全て読み込む（フォルダ名のアルファベット順）
2. Pythonスクリプトで `damage-report.xlsx` を生成する

### Pythonスクリプト仕様

`openpyxl` を使用。`pip install openpyxl` が必要な場合はインストールする。

### シート構成

**シート1: 全ログ（raw）**

全部隊のresult.csvを結合。ソース列（フォルダ名）を先頭に追加。

| 列 | 内容 |
|---|---|
| フォルダ | ソースフォルダ名（kouki, enshou等） |
| 画像 | 画像ファイル名 |
| 部隊名 | 部隊名 |
| 兵力 | 兵力値 |
| 対象 | 城壁 |
| 損害値 | ダメージ数値 |
| 種別 | 通常/会心/撃心/戦法 |
| 発動者 | 武将名 |
| 戦法名 | 戦法名 |

- ヘッダー行は太字、フィルタ（オートフィルタ）を有効にする
- 損害値列は数値書式（カンマ区切り `#,##0`）
- 列幅を自動調整する

**シート2: 部隊別サマリー**

| 列 | 内容 |
|---|---|
| 部隊名 | 部隊名（項籍隊、袁紹隊等） |
| 攻撃回数 | 全行数（通常+会心+撃心+戦法） |
| 合計損害 | 損害値の合計 |
| 平均損害 | 損害値の平均 |
| 最大損害 | 損害値の最大値 |
| 最小損害 | 損害値の最小値 |
| 会心率 | 会心の行数 / 全行数（%表示） |
| 撃心回数 | 撃心の行数 |
| 戦法回数 | 戦法の行数 |
| 戦法合計損害 | 種別=戦法の損害合計 |
| 通常合計損害 | 種別=通常+会心+撃心の損害合計 |

- ヘッダー行は太字
- 数値はカンマ区切り（`#,##0`）、率は%書式（`0.0%`）
- 最終行に全部隊の合計行を追加

**シート3: 種別内訳**

部隊×種別のクロス集計。

| 列 | 内容 |
|---|---|
| 部隊名 | 部隊名 |
| 種別 | 通常 / 会心 / 撃心 / 戦法 |
| 件数 | 該当行数 |
| 合計損害 | 損害値の合計 |
| 平均損害 | 損害値の平均 |
| 最大損害 | 損害値の最大値 |
| 最小損害 | 損害値の最小値 |

- ヘッダー行は太字、数値はカンマ区切り
- 部隊名でグループ化（同じ部隊名の行をまとめる）

### 出力先

```
tasks/damage-logs/damage-report.xlsx
tasks/damage-logs/merged-result.csv    ← CSVも同時出力（バックアップ用）
```

---

## 実データで確認済みのパターン

### 通常攻撃 → 通常ダメージ
```
項籍隊（28372）が攻撃
  城壁に1906の損害
```
→ `項籍隊,28372,城壁,1906,通常,,`

### 戦法3連鎖（起点戦法のダメージなし）
```
項籍隊（23904）の孫尚香が戦法「風虎佳烈」を発動
続けて程普が戦法「練武修文」を発動
  城壁に2383917の損害
続けて項籍が戦法「抜山蓋世」を発動
  城壁に5900041の損害
```
→ 風虎佳烈: CSV行なし（ダメージなし）
→ `項籍隊,23904,城壁,2383917,戦法,程普,練武修文`
→ `項籍隊,23904,城壁,5900041,戦法,項籍,抜山蓋世`

### 戦法2連鎖（練武修文スキップ）
```
項籍隊（24353）の孫尚香が戦法「風虎佳烈」を発動
続けて項籍が戦法「抜山蓋世」を発動
  城壁に5752401の損害
```
→ `項籍隊,24353,城壁,5752401,戦法,項籍,抜山蓋世`

### 主将でない武将が戦法起点
```
項籍隊（24353）の程普が戦法「練武修文」を発動
  城壁に2686590の損害
```
→ `項籍隊,24353,城壁,2686590,戦法,程普,練武修文`

### 通常攻撃（会心）
```
項籍隊（23932）が攻撃
  城壁に2694534の損害（会心）
```
→ `項籍隊,23932,城壁,2694534,会心,,`

### 範囲攻撃（城壁 + 洛陽歩兵/騎兵/弓兵）
```
項籍隊（24353）が攻撃
  城壁に6892168の損害（会心）
  洛陽弓兵に426433の損害（会心）
  洛陽騎兵に410917の損害（会心）
```
→ `項籍隊,24353,城壁,6892168,会心,,`
→ 洛陽弓兵・洛陽騎兵行はスキップ

### 自部隊行動通知（スキップ）
```
あまつきの項籍隊が行動
```
→ スキップ

---

## エッジケース

- 1枚の画像に複数の攻撃サイクルが含まれる
- 範囲攻撃で城壁+洛陽歩兵/騎兵/弓兵のダメージが混在 → 城壁行のみ抽出
- 連鎖戦法の回数は可変（2〜3連鎖を確認済み）
- 連鎖の起点戦法にダメージ行がない場合がある（バフ系戦法）
- 画像の上端・下端でログが途中で切れている（不完全行はスキップ）
- 同じログ内容が前後の画像で重複する場合がある → 重複除去は行わず全行出力
- 兵力が画像間で変動する（戦闘で兵力が減るため正常）
- 部隊ごとにログを絞り込んでスクショを撮るため、1フォルダ内は基本的に同一部隊のログのみ

---

## 処理完了後の出力（各フォルダ）

```
=== kouki ダメージログ解析完了 ===
処理画像数: 50
スキップ（処理済み）: 0
失敗: 0
抽出行数: 342
合計損害値: 1,234,567,890
出力先: tasks/damage-logs/kouki/result.csv
```

---

## 注意

- BACKLOG.md / INBOX.md の更新は不要（一時的な解析タスク）
- コミット・プッシュも不要（ローカル作業）
- **各フォルダ完了時にステートマシンをリセットする。フォルダ間でステートは引き継がない**
- **最初からやり直したい場合は対象フォルダの progress.json と result.csv を手動削除してから再実行**
- **compact後の再開:** 「`tasks/damage-logs/TASK.md` を読んで全フォルダを処理して」（同じ指示でOK）

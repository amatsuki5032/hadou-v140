# タスク: 戦闘ログOCRツール作成

## 概要

三國志覇道のスクリーンショットから戦闘ログをOCRで読み取り、城壁へのダメージデータをCSV出力するツール。

## 配置

```
hadou-v140/
├── damage-log.html           ← 単一ファイル（HTML + CSS + JS）
```

※ formation-finder.html と同じくルート直置き。サブディレクトリは作らない。

## 技術

- Tesseract.js（CDN: https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js）
- 言語: jpn（日本語）+ eng（数字認識補助）
- UIテーマ: common-theme.css を読み込み（同階層）
- data-*.js の参照は不要（このツールは独立）

## 機能フロー

```
画像をドロップ/選択（複数対応）
  ↓
Tesseract.js でOCR（日本語）
  ↓
テキストを行単位で分割
  ↓
フィルタ＆パース（自部隊 + 城壁ダメージのみ抽出）
  ↓
テーブル表示 + CSVダウンロード
```

## ログのパターン（OCR後のテキスト解析用）

### 抽出対象

```
パターン1: 通常攻撃の開始
  「袁紹隊（38317）が攻撃」
  → 部隊名=袁紹隊, 兵力=38317 を記憶（後続のダメージ行に紐づける）

パターン2: ダメージ行（城壁のみ）
  「城壁に9638の損害」           → 種別=通常
  「城壁に24141の損害（会心）」   → 種別=会心
  「城壁に10958955の損害（撃心）」→ 種別=撃心

パターン3: 戦法発動（自部隊）
  「袁紹隊（38269）の袁紹が戦法「強盛莫敵」を発動」
  → 部隊名=袁紹隊, 兵力=38269, 発動者=袁紹, 戦法名=強盛莫敵

パターン4: 連鎖戦法
  「続けて董卓が戦法「暴戻狂傲」を発動」
  → 発動者=董卓, 戦法名=暴戻狂傲（部隊名・兵力は直前の戦法発動行を引き継ぐ）
```

### スキップ対象

```
パターンA: 他プレイヤーの行
  「あおりくの劉備隊の劉備が戦法「英風弘烈」を発動」
  「侯建命の白起隊の白起が戦法「出奇無窮」を発動」
  「昨日のジョーの諸葛亮隊の諸葛亮が戦法「臥龍天舞」を発動」
  → 判定: 「○○の○○隊」のパターン（隊の前に「の」がある）

パターンB: 城壁以外へのダメージ
  「洛陽弓兵に3286の損害（会心）」
  → 対象が「城壁」でなければスキップ
```

## 正規表現（参考）

```javascript
// 通常攻撃の開始
// 「袁紹隊（38317）が攻撃」
const reAttack = /^(.+?隊)(?:[（(](\d+)[）)])?\s*が攻撃/;

// ダメージ行（城壁のみ）
// 「城壁に9638の損害」「城壁に24141の損害（会心）」
const reDamage = /城壁に(\d+)の損害(?:[（(](会心|撃心)[）)])?/;

// 戦法発動（自部隊）
// 「袁紹隊（38269）の袁紹が戦法「強盛莫敵」を発動」
const reTactic = /^(.+?隊)[（(](\d+)[）)]\s*の(.+?)が戦法[「｢](.+?)[」｣]を発動/;

// 連鎖戦法
// 「続けて董卓が戦法「暴戻狂傲」を発動」
const reChain = /^続けて(.+?)が戦法[「｢](.+?)[」｣]を発動/;

// 他プレイヤー判定（スキップ用）
// 「○○の○○隊の○○が戦法」→ 隊の前に「の」がある
const reOtherPlayer = /の.+?隊の.+?が戦法/;
```

## CSV出力フォーマット

```csv
部隊名,兵力,対象,損害値,種別,発動者,戦法名
袁紹隊,38317,城壁,9638,通常,,
袁紹隊,38317,城壁,24141,会心,,
袁紹隊,38269,城壁,1343981,戦法,袁紹,強盛莫敵
袁紹隊,38269,城壁,10958955,撃心,董卓,暴戻狂傲
```

- 種別: 通常 / 会心 / 撃心 / 戦法（戦法ダメージで会心・撃心でないもの）
- 発動者・戦法名: 通常攻撃の場合は空
- ファイル名: `damage-log_YYYYMMDD_HHMMSS.csv`

## UI設計

### レイアウト

```
┌─────────────────────────────────────┐
│ 戦闘ログ → CSV                       │  ← ヘッダー（ボルドーライン）
├─────────────────────────────────────┤
│                                     │
│   画像をドロップ または クリックで選択  │  ← ドロップエリア（点線ボーダー）
│   （複数画像対応）                    │
│                                     │
├─────────────────────────────────────┤
│ [OCR実行]          [CSVダウンロード]  │  ← ボタン群
├─────────────────────────────────────┤
│ OCR進捗: ████████░░ 80%              │  ← プログレスバー（処理中のみ表示）
├─────────────────────────────────────┤
│ OCR生テキスト（トグル表示）            │  ← デバッグ用、デフォルト非表示
├─────────────────────────────────────┤
│ 部隊名 │ 兵力 │ 損害値 │ 種別 │ ... │  ← 結果テーブル（カード、左ボルドー）
│ 袁紹隊 │38317│  9638 │ 通常 │     │
│ 袁紹隊 │38317│ 24141 │ 会心 │     │
│  ...   │     │       │     │     │
├─────────────────────────────────────┤
│ 合計損害: 12,345,678                 │  ← サマリー
│ 抽出行数: 15                         │
└─────────────────────────────────────┘
```

### UI要件

- 複数画像を一度にドロップ可能（順番にOCR処理、結果は結合）
- OCR処理中はプログレスバー表示
- CSVダウンロードボタンでファイルダウンロード
- OCR生テキストはトグルで表示/非表示（誤認識の確認用）
- テーマ切り替えボタン（🌙/☀）
- common-theme.css のクラスを活用（.card, .primary, button, .badge 等）

## OCR精度への対策

### 前処理（Canvas）

画像をCanvasで前処理してからOCRに渡す:
- グレースケール変換
- コントラスト強調
- 白黒反転（暗い背景＋白文字 → 白背景＋黒文字にする）

### 後処理（テキスト補正）

```javascript
// 数字の誤認識補正
text = text.replace(/[oOоО]/g, '0');
text = text.replace(/[lIｌＩ]/g, '1');

// 括弧の正規化
text = text.replace(/[（(]/g, '（');
text = text.replace(/[）)]/g, '）');

// 「」の正規化
text = text.replace(/[「｢﹁]/g, '「');
text = text.replace(/[」｣﹂]/g, '」');
```

### パースできなかった行の扱い

- 無視（エラーにしない）
- OCR生テキストのトグル表示でユーザーが目視確認可能

## 注意事項

- CLAUDE.md のUI/デザインルールに従うこと（雨夜の月テーマ）
- 絵文字＋テキストの組み合わせ禁止
- damage-log.html 単一ファイルで完結（CSS・JSは埋め込み）
- ネットワーク必須（Tesseract.js CDN + 言語データダウンロード）

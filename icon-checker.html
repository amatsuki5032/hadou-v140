<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>アイコン不足チェッカー</title>
<style>
body { background: #09090c; color: #e2e4ec; font-family: -apple-system, 'Noto Sans JP', sans-serif; padding: 20px; }
h1 { font-size: 20px; border-bottom: 2px solid #800020; padding-bottom: 12px; }
h2 { font-size: 17px; margin-top: 28px; color: #f0f1f5; }
.summary { margin: 16px 0; padding: 12px 16px; background: #0e0e12; border-radius: 8px; font-size: 14px; line-height: 1.8; }
.ok { color: #22c55e; } .ng { color: #ef4444; }
.rarity-section { margin: 16px 0; }
.rarity-title { font-size: 14px; margin-bottom: 6px; color: #9a9eb0; }
.grid { display: flex; flex-wrap: wrap; gap: 4px; }
.item { display: flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 4px; font-size: 12px; min-width: 140px; }
.item.ok { background: #0a1a0a; color: #4ade80; }
.item.ng { background: #1a0a0a; color: #f87171; font-weight: bold; }
.item img { width: 28px; height: 28px; border-radius: 2px; object-fit: cover; }
.item .placeholder { width: 28px; height: 28px; background: #1c1c24; border: 1px dashed #606478; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 10px; }
#progress { color: #9a9eb0; font-size: 13px; margin: 8px 0; }
button { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
button:hover { background: #1d4ed8; }
.filter-bar { margin: 12px 0; display: flex; gap: 8px; align-items: center; }
.filter-btn { padding: 6px 14px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #1c1c24; background: #121216; color: #9a9eb0; }
.filter-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
.tab-bar { display: flex; gap: 4px; margin: 16px 0; }
.tab { padding: 8px 16px; border-radius: 6px 6px 0 0; font-size: 13px; cursor: pointer; border: 1px solid #1c1c24; border-bottom: none; background: #121216; color: #9a9eb0; }
.tab.active { background: #0e0e12; color: #f0f1f5; border-color: #2e2e38; }
.copy-btn { background: #121216; color: #9a9eb0; border: 1px solid #1c1c24; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; }
.copy-btn:hover { background: #1a1a1e; color: #e2e4ec; }
.data-status { font-size: 13px; color: #606478; margin: 8px 0; }
.data-status .loaded { color: #22c55e; }
.data-status .error { color: #ef4444; }
</style>
</head>
<body>
<h1>アイコン不足チェッカー</h1>
<p style="font-size:13px;color:#606478">data-generals.js / data-all-treasures.js を動的に読み込み、アイコンの存在をチェックします。</p>
<div class="data-status" id="dataStatus">データ読み込み中...</div>
<button onclick="runCheck()" id="startBtn" disabled>チェック開始</button>
<p id="progress"></p>

<div class="tab-bar" id="tabBar" style="display:none">
    <span class="tab active" onclick="switchTab('generals',this)">武将</span>
    <span class="tab" onclick="switchTab('treasures',this)">名宝</span>
</div>
<div class="filter-bar" id="filterBar" style="display:none">
    <span class="filter-btn active" onclick="setFilter('all',this)">すべて</span>
    <span class="filter-btn" onclick="setFilter('missing',this)">不足のみ</span>
    <button class="copy-btn" onclick="copyMissing()">不足リストをコピー</button>
</div>

<div class="summary" id="summary" style="display:none"></div>
<div id="results"></div>

<!-- 既存のデータファイルを読み込み（同ディレクトリにある前提） -->
<script src="data-generals.js"></script>
<script src="data-all-treasures.js"></script>

<script>
// データファイルのグローバル変数から動的に取得
let GENERALS = [];
let TREASURES = [];

function initData() {
    const status = document.getElementById('dataStatus');
    let lines = [];

    // 武将データ（GENERALS_DATA or EMBEDDED_GENERALS_DATA）
    const genSource = window.GENERALS_DATA || window.EMBEDDED_GENERALS_DATA;
    if (genSource && Array.isArray(genSource)) {
        GENERALS = genSource.map(g => ({ id: g.id, r: g.rarity, n: g.name }));
        const ro = { LR: 0, UR: 1, SSR: 2, SR: 3, R: 4, N: 5 };
        GENERALS.sort((a, b) => (ro[a.r] ?? 9) - (ro[b.r] ?? 9) || a.id - b.id);
        lines.push(`<span class="loaded">✓</span> 武将: ${GENERALS.length}名`);
    } else {
        lines.push(`<span class="error">✕</span> 武将データ未検出 (data-generals.js)`);
    }

    // 名宝データ（EMBEDDED_TREASURES_DATA or ALL_TREASURES_DATA）
    const treSource = window.EMBEDDED_TREASURES_DATA || window.ALL_TREASURES_DATA;
    if (treSource && Array.isArray(treSource)) {
        TREASURES = treSource.map(t => ({ id: t.id, n: t.name, c: t.category }));
        lines.push(`<span class="loaded">✓</span> 名宝: ${TREASURES.length}件`);
    } else {
        lines.push(`<span class="error">✕</span> 名宝データ未検出 (data-all-treasures.js)`);
    }

    status.innerHTML = lines.join(' / ');
    
    if (GENERALS.length > 0 || TREASURES.length > 0) {
        document.getElementById('startBtn').disabled = false;
    }
}

const RARITY_ORDER = ['LR','UR','SSR','SR','R','N'];
const TREASURE_CATS = ['武器','防具','文物'];
let genResults = [];
let treResults = [];
let currentTab = 'generals';
let filterMode = 'all';

function checkImage(url) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url;
    });
}

async function runCheck() {
    const prog = document.getElementById('progress');
    const btn = document.getElementById('startBtn');
    btn.disabled = true;
    genResults = [];
    treResults = [];
    
    // 武将チェック
    for (let i = 0; i < GENERALS.length; i++) {
        const g = GENERALS[i];
        const path = `./icons/generals/${g.r}/${g.r}${g.n}.png`;
        prog.textContent = `武将チェック中... ${i+1}/${GENERALS.length} (${g.r} ${g.n})`;
        const ok = await checkImage(path);
        genResults.push({ ...g, path, ok });
    }
    
    // 名宝チェック（通常 + UR）
    for (let i = 0; i < TREASURES.length; i++) {
        const t = TREASURES[i];
        const normalPath = `./icons/treasures/normal/${t.n}.png`;
        const urPath = `./icons/treasures/UR/UR${t.n}.png`;
        prog.textContent = `名宝チェック中... ${i+1}/${TREASURES.length} (${t.n})`;
        const normalOk = await checkImage(normalPath);
        const urOk = await checkImage(urPath);
        treResults.push({ ...t, normalPath, urPath, normalOk, urOk });
    }
    
    prog.textContent = 'チェック完了';
    btn.disabled = false;
    document.getElementById('tabBar').style.display = 'flex';
    document.getElementById('filterBar').style.display = 'flex';
    renderResults();
}

function switchTab(tab, el) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    renderResults();
}

function setFilter(mode, el) {
    filterMode = mode;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    renderResults();
}

function renderResults() {
    const container = document.getElementById('results');
    const summary = document.getElementById('summary');
    summary.style.display = 'block';
    
    const genOk = genResults.filter(r => r.ok).length;
    const genNg = genResults.length - genOk;
    const treNormalOk = treResults.filter(r => r.normalOk).length;
    const treNormalNg = treResults.length - treNormalOk;
    const treUrOk = treResults.filter(r => r.urOk).length;
    const treUrNg = treResults.length - treUrOk;
    
    let genBreakdown = RARITY_ORDER.map(r => {
        const all = genResults.filter(x => x.r === r);
        const ng = all.filter(x => !x.ok);
        return `${r}: <span class="${ng.length > 0 ? 'ng' : 'ok'}">${all.length - ng.length}/${all.length}</span>`;
    }).join(' / ');
    
    summary.innerHTML = `
        <b>武将:</b> <span class="ok">${genOk}件 OK</span> / <span class="ng">${genNg}件 不足</span> （全${genResults.length}件）<br>
        ${genBreakdown}<br>
        <b>名宝(通常):</b> <span class="ok">${treNormalOk}件 OK</span> / <span class="ng">${treNormalNg}件 不足</span><br>
        <b>名宝(UR):</b> <span class="ok">${treUrOk}件 OK</span> / <span class="ng">${treUrNg}件 不足</span>
    `;
    
    let html = '';
    
    if (currentTab === 'generals') {
        for (const r of RARITY_ORDER) {
            const items = genResults.filter(x => x.r === r);
            const filtered = filterMode === 'missing' ? items.filter(x => !x.ok) : items;
            if (filtered.length === 0) continue;
            const ngCount = items.filter(x => !x.ok).length;
            html += `<div class="rarity-section">`;
            html += `<div class="rarity-title">${r} (${ngCount > 0 ? ngCount + '件不足' : '全件OK'})</div>`;
            html += `<div class="grid">`;
            for (const item of filtered) {
                if (item.ok) {
                    html += `<div class="item ok"><img src="${item.path}">${item.n}</div>`;
                } else {
                    html += `<div class="item ng"><div class="placeholder">✕</div>${item.n}</div>`;
                }
            }
            html += `</div></div>`;
        }
    } else {
        html += `<h2>通常アイコン</h2>`;
        for (const cat of TREASURE_CATS) {
            const items = treResults.filter(x => x.c === cat);
            const filtered = filterMode === 'missing' ? items.filter(x => !x.normalOk) : items;
            if (filtered.length === 0) continue;
            const ngCount = items.filter(x => !x.normalOk).length;
            html += `<div class="rarity-section">`;
            html += `<div class="rarity-title">${cat} (${ngCount > 0 ? ngCount + '件不足' : '全件OK'})</div>`;
            html += `<div class="grid">`;
            for (const item of filtered) {
                if (item.normalOk) {
                    html += `<div class="item ok"><img src="${item.normalPath}">${item.n}</div>`;
                } else {
                    html += `<div class="item ng"><div class="placeholder">✕</div>${item.n}</div>`;
                }
            }
            html += `</div></div>`;
        }
        html += `<h2>URアイコン</h2>`;
        for (const cat of TREASURE_CATS) {
            const items = treResults.filter(x => x.c === cat);
            const filtered = filterMode === 'missing' ? items.filter(x => !x.urOk) : items;
            if (filtered.length === 0) continue;
            const ngCount = items.filter(x => !x.urOk).length;
            html += `<div class="rarity-section">`;
            html += `<div class="rarity-title">${cat} (${ngCount > 0 ? ngCount + '件不足' : '全件OK'})</div>`;
            html += `<div class="grid">`;
            for (const item of filtered) {
                if (item.urOk) {
                    html += `<div class="item ok"><img src="${item.urPath}">${item.n}</div>`;
                } else {
                    html += `<div class="item ng"><div class="placeholder">✕</div>${item.n}</div>`;
                }
            }
            html += `</div></div>`;
        }
    }
    container.innerHTML = html;
}

function copyMissing() {
    let lines = [];
    if (currentTab === 'generals') {
        const missing = genResults.filter(r => !r.ok);
        lines.push(`=== 武将アイコン不足 (${missing.length}件) ===`);
        for (const r of RARITY_ORDER) {
            const items = missing.filter(x => x.r === r);
            if (items.length === 0) continue;
            lines.push(`\n--- ${r} (${items.length}件) ---`);
            items.forEach(g => lines.push(`${g.r}${g.n}.png`));
        }
    } else {
        const normalMissing = treResults.filter(r => !r.normalOk);
        const urMissing = treResults.filter(r => !r.urOk);
        lines.push(`=== 名宝アイコン不足 ===`);
        lines.push(`\n--- 通常 (${normalMissing.length}件) ---`);
        normalMissing.forEach(t => lines.push(`${t.n}.png`));
        lines.push(`\n--- UR (${urMissing.length}件) ---`);
        urMissing.forEach(t => lines.push(`UR${t.n}.png`));
    }
    navigator.clipboard.writeText(lines.join('\n')).then(() => {
        alert('クリップボードにコピーしました');
    });
}

// ページ読み込み完了時にデータ初期化
window.addEventListener('DOMContentLoaded', initData);
</script>
</body>
</html>

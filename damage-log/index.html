<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆ¦é—˜ãƒ­ã‚° â†’ CSV</title>
<link rel="stylesheet" href="../styles.css">
<style>
/* ===== styles.css ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ ===== */
body {
    min-width: auto;
    padding: 20px;
    max-width: 900px;
    margin: 0 auto;
    overflow-x: hidden;
}

/* ===== Header ===== */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid var(--bordeaux);
    padding-bottom: 12px;
    margin-bottom: 20px;
}
.header h1 { font-size: 20px; color: var(--text-primary); }
.header .theme-toggle {
    font-size: 18px;
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 0;
}

/* ===== Drop zone ===== */
.drop-zone {
    border: 2px dashed var(--border-base);
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    margin-bottom: 16px;
}
.drop-zone:hover,
.drop-zone.drag-over {
    border-color: var(--accent);
    background: rgba(37, 99, 235, 0.05);
}
.drop-zone-text { color: var(--text-secondary); font-size: 14px; }
.drop-zone-sub { color: var(--text-muted); font-size: 12px; margin-top: 8px; }

/* ===== File list ===== */
.file-list { margin-bottom: 16px; }
.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--bg-card);
    border-radius: 4px;
    margin-bottom: 4px;
    font-size: 13px;
}
.file-item-name {
    color: var(--text-body);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.file-item-remove {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 16px;
    padding: 0 4px;
    flex-shrink: 0;
}
.file-item-remove:hover { color: var(--danger); }

/* ===== Buttons ===== */
.button-row {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}
button.primary {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 20px;
    font-size: 14px;
    cursor: pointer;
    font-family: inherit;
}
button.primary:hover { background: var(--accent-hover); }
button.primary:disabled { opacity: 0.5; cursor: not-allowed; }
button.secondary {
    background: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border-base);
    border-radius: 6px;
    padding: 8px 20px;
    font-size: 14px;
    cursor: pointer;
    font-family: inherit;
}
button.secondary:hover { border-color: var(--accent); }
button.secondary:disabled { opacity: 0.5; cursor: not-allowed; }

/* ===== Progress ===== */
.progress-area {
    margin-bottom: 16px;
    display: none;
}
.progress-area.visible { display: block; }
.progress-status {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 6px;
}
.progress-bar-bg {
    height: 8px;
    background: var(--bg-elevated);
    border-radius: 4px;
    overflow: hidden;
}
.progress-bar-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 4px;
    transition: width 0.3s;
    width: 0%;
}

/* ===== Raw text ===== */
.raw-text-section { margin-bottom: 16px; }
.raw-text-toggle {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 13px;
    cursor: pointer;
    padding: 4px 0;
    font-family: inherit;
}
.raw-text-toggle:hover { color: var(--text-primary); }
.raw-text-content {
    display: none;
    background: var(--bg-card);
    border: 1px solid var(--border-base);
    border-radius: 6px;
    padding: 12px;
    margin-top: 8px;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 12px;
    color: var(--text-body);
    font-family: monospace;
}
.raw-text-content.visible { display: block; }

/* ===== Results table ===== */
.results-card {
    background: var(--bg-card);
    border-radius: 8px;
    border-left: 3px solid var(--bordeaux);
    overflow-x: auto;
    margin-bottom: 16px;
}
.results-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    min-width: 600px;
}
.results-table th {
    background: var(--bg-elevated);
    color: var(--text-secondary);
    font-weight: 600;
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-base);
    font-size: 12px;
    white-space: nowrap;
}
.results-table td {
    padding: 6px 12px;
    border-bottom: 1px solid var(--border-base);
    color: var(--text-body);
}
.results-table tr:last-child td { border-bottom: none; }
.results-table tr:hover td { background: var(--bg-elevated); }
.results-table .num {
    text-align: right;
    font-family: monospace;
}
.type-badge {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
}
.type-é€šå¸¸ { background: rgba(148, 163, 184, 0.15); color: #94a3b8; }
.type-ä¼šå¿ƒ { background: rgba(244, 208, 63, 0.15); color: #f4d03f; }
.type-æ’ƒå¿ƒ { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
.type-æˆ¦æ³• { background: rgba(37, 99, 235, 0.15); color: #60a5fa; }
.no-data {
    text-align: center;
    color: var(--text-muted);
    padding: 20px 12px;
}
/* è¾æ›¸è£œæ­£ã•ã‚ŒãŸã‚»ãƒ« */
.corrected {
    border-bottom: 1px dashed #f4d03f;
    cursor: help;
}
/* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›† */
.results-table td.editable { cursor: text; }
.results-table td.editable:hover { background: rgba(37, 99, 235, 0.08); }
.cell-input {
    background: var(--bg-elevated);
    border: 1px solid var(--accent);
    border-radius: 3px;
    color: var(--text-body);
    font-size: 13px;
    font-family: inherit;
    padding: 2px 4px;
    width: 100%;
    box-sizing: border-box;
}
.cell-input.num { text-align: right; font-family: monospace; }
/* è¡Œå‰Šé™¤ */
.results-table .col-del { width: 28px; padding: 4px; text-align: center; }
.row-delete {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 14px;
    padding: 0 4px;
    line-height: 1;
}
.row-delete:hover { color: var(--danger); }

/* ===== Summary ===== */
.summary {
    background: var(--bg-card);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 14px;
    color: var(--text-body);
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
}
.summary-label { color: var(--text-secondary); }
.summary-value {
    font-weight: 600;
    color: var(--text-primary);
    font-family: monospace;
    margin-left: 6px;
}
</style>
</head>
<body>

<div class="header">
    <h1>æˆ¦é—˜ãƒ­ã‚° â†’ CSV</h1>
    <button class="theme-toggle" id="themeToggle" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ™</button>
</div>

<div class="drop-zone" id="dropZone">
    <div class="drop-zone-text">ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ</div>
    <div class="drop-zone-sub">ï¼ˆè¤‡æ•°ç”»åƒå¯¾å¿œï¼‰</div>
    <input type="file" id="fileInput" accept="image/*" multiple style="display:none">
</div>

<div class="file-list" id="fileList"></div>

<div class="button-row">
    <button class="primary" id="btnOcr" disabled>OCRå®Ÿè¡Œ</button>
    <button class="secondary" id="btnCsv" disabled>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
</div>

<div class="progress-area" id="progressArea">
    <div class="progress-status" id="progressStatus">æº–å‚™ä¸­...</div>
    <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progressFill"></div>
    </div>
</div>

<div class="raw-text-section" id="rawTextSection" style="display:none">
    <button class="raw-text-toggle" id="rawTextToggle">â–¶ OCRç”Ÿãƒ†ã‚­ã‚¹ãƒˆ</button>
    <div class="raw-text-content" id="rawTextContent"></div>
</div>

<div id="resultsArea" style="display:none">
    <div class="results-card">
        <table class="results-table">
            <thead>
                <tr>
                    <th>éƒ¨éšŠå</th>
                    <th>å…µåŠ›</th>
                    <th>å¯¾è±¡</th>
                    <th class="num">æå®³å€¤</th>
                    <th>ç¨®åˆ¥</th>
                    <th>ç™ºå‹•è€…</th>
                    <th>æˆ¦æ³•å</th>
                    <th class="col-del"></th>
                </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
    </div>
    <div class="summary" id="summary"></div>
</div>

<script src="../data-generals.js"></script>
<script src="../data-skill-db.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
(function() {
    // ===== è¾æ›¸ï¼ˆæ­¦å°†åãƒ»æŠ€èƒ½åï¼‰ =====
    var generalNames = [];
    var skillNames = [];
    if (typeof EMBEDDED_GENERALS_DATA !== 'undefined') {
        generalNames = EMBEDDED_GENERALS_DATA.map(function(g) { return g.name; });
    }
    if (typeof SKILL_DB !== 'undefined') {
        skillNames = Object.keys(SKILL_DB);
    }

    // Levenshteinè·é›¢
    function levenshtein(a, b) {
        if (a === b) return 0;
        var la = a.length, lb = b.length;
        if (la === 0) return lb;
        if (lb === 0) return la;
        var prev = [];
        var curr = [];
        for (var j = 0; j <= lb; j++) prev[j] = j;
        for (var i = 1; i <= la; i++) {
            curr[0] = i;
            for (var j = 1; j <= lb; j++) {
                var cost = a[i - 1] === b[j - 1] ? 0 : 1;
                curr[j] = Math.min(prev[j] + 1, curr[j - 1] + 1, prev[j - 1] + cost);
            }
            var tmp = prev; prev = curr; curr = tmp;
        }
        return prev[lb];
    }

    // è¾æ›¸ã‹ã‚‰æœ€ã‚‚è¿‘ã„åå‰ã‚’æ¤œç´¢ï¼ˆé–¾å€¤ä»¥å†…ãªã‚‰è£œæ­£ï¼‰
    function findClosest(input, dictionary, maxDist) {
        if (!input || dictionary.length === 0) return input;
        var best = null;
        var bestDist = Infinity;
        for (var i = 0; i < dictionary.length; i++) {
            var d = levenshtein(input, dictionary[i]);
            if (d < bestDist) {
                bestDist = d;
                best = dictionary[i];
            }
            if (d === 0) return input; // å®Œå…¨ä¸€è‡´
        }
        if (bestDist <= maxDist && bestDist > 0) return best;
        return input;
    }

    // ãƒ‘ãƒ¼ã‚¹çµæœã®è¾æ›¸ãƒ™ãƒ¼ã‚¹è£œæ­£ï¼ˆè£œæ­£å‰ã®å€¤ã‚’ _orig ã«ä¿æŒï¼‰
    function correctResults(results) {
        return results.map(function(r) {
            var c = { unit: r.unit, troops: r.troops, target: r.target,
                      damage: r.damage, type: r.type, caster: r.caster, tactic: r.tactic };
            // éƒ¨éšŠå: ã€ŒXéšŠã€ã®Xã‚’æ­¦å°†åè¾æ›¸ã§è£œæ­£
            if (c.unit && c.unit.endsWith('éšŠ')) {
                var baseName = c.unit.slice(0, -1);
                var maxDist = baseName.length <= 2 ? 1 : Math.ceil(baseName.length * 0.4);
                var fixed = findClosest(baseName, generalNames, maxDist);
                if (fixed !== baseName) { c._origUnit = c.unit; c.unit = fixed + 'éšŠ'; }
            }
            // ç™ºå‹•è€…: æ­¦å°†åè¾æ›¸ã§è£œæ­£
            if (c.caster) {
                var maxDist = c.caster.length <= 2 ? 1 : Math.ceil(c.caster.length * 0.4);
                var fixed = findClosest(c.caster, generalNames, maxDist);
                if (fixed !== c.caster) { c._origCaster = c.caster; c.caster = fixed; }
            }
            // æˆ¦æ³•å: æŠ€èƒ½åè¾æ›¸ã§è£œæ­£
            if (c.tactic) {
                var maxDist = c.tactic.length <= 2 ? 1 : Math.ceil(c.tactic.length * 0.3);
                var fixed = findClosest(c.tactic, skillNames, maxDist);
                if (fixed !== c.tactic) { c._origTactic = c.tactic; c.tactic = fixed; }
            }
            return c;
        });
    }

    // ===== State =====
    var files = [];
    var parsedResults = [];
    var rawText = '';
    var isProcessing = false;
    var currentImageIndex = 0;
    var totalImages = 0;

    // ===== DOM =====
    var dropZone = document.getElementById('dropZone');
    var fileInput = document.getElementById('fileInput');
    var fileList = document.getElementById('fileList');
    var btnOcr = document.getElementById('btnOcr');
    var btnCsv = document.getElementById('btnCsv');
    var progressArea = document.getElementById('progressArea');
    var progressStatus = document.getElementById('progressStatus');
    var progressFill = document.getElementById('progressFill');
    var rawTextSection = document.getElementById('rawTextSection');
    var rawTextToggle = document.getElementById('rawTextToggle');
    var rawTextContent = document.getElementById('rawTextContent');
    var resultsArea = document.getElementById('resultsArea');
    var resultsBody = document.getElementById('resultsBody');
    var summary = document.getElementById('summary');
    var themeToggle = document.getElementById('themeToggle');

    // ===== Theme =====
    if (localStorage.getItem('damage-log-theme') === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        themeToggle.textContent = 'â˜€';
    }
    themeToggle.addEventListener('click', function() {
        var isLight = document.documentElement.getAttribute('data-theme') === 'light';
        if (isLight) {
            document.documentElement.removeAttribute('data-theme');
            themeToggle.textContent = 'ğŸŒ™';
            localStorage.setItem('damage-log-theme', 'dark');
        } else {
            document.documentElement.setAttribute('data-theme', 'light');
            themeToggle.textContent = 'â˜€';
            localStorage.setItem('damage-log-theme', 'light');
        }
    });

    // ===== File handling =====
    dropZone.addEventListener('click', function() { fileInput.click(); });
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', function() {
        dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        addFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', function() {
        addFiles(fileInput.files);
        fileInput.value = '';
    });

    function addFiles(newFiles) {
        for (var i = 0; i < newFiles.length; i++) {
            if (newFiles[i].type.startsWith('image/')) {
                files.push(newFiles[i]);
            }
        }
        renderFileList();
        btnOcr.disabled = files.length === 0 || isProcessing;
    }

    function removeFile(index) {
        files.splice(index, 1);
        renderFileList();
        btnOcr.disabled = files.length === 0 || isProcessing;
    }

    function renderFileList() {
        fileList.innerHTML = '';
        files.forEach(function(f, i) {
            var item = document.createElement('div');
            item.className = 'file-item';
            var name = document.createElement('span');
            name.className = 'file-item-name';
            name.textContent = f.name;
            var btn = document.createElement('button');
            btn.className = 'file-item-remove';
            btn.textContent = '\u2715';
            btn.addEventListener('click', function() { removeFile(i); });
            item.appendChild(name);
            item.appendChild(btn);
            fileList.appendChild(item);
        });
    }

    // ===== Image preprocessing =====
    function loadImage(file) {
        return new Promise(function(resolve, reject) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() { resolve(img); };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function preprocessImage(img) {
        // ç”»åƒã‚’2å€ã«æ‹¡å¤§ï¼ˆOCRç²¾åº¦å‘ä¸Šï¼‰
        var scale = 2;
        var canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth * scale;
        canvas.height = img.naturalHeight * scale;
        var ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var d = imageData.data;
        var totalBrightness = 0;
        var pixelCount = d.length / 4;

        // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›
        for (var i = 0; i < d.length; i += 4) {
            var gray = d[i] * 0.299 + d[i + 1] * 0.587 + d[i + 2] * 0.114;
            d[i] = d[i + 1] = d[i + 2] = gray;
            totalBrightness += gray;
        }
        var avgBrightness = totalBrightness / pixelCount;

        // ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·èª¿ï¼ˆå¼·ã‚ï¼‰
        var contrast = 80;
        var factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
        for (var i = 0; i < d.length; i += 4) {
            var val = Math.min(255, Math.max(0, factor * (d[i] - 128) + 128));
            d[i] = d[i + 1] = d[i + 2] = val;
        }

        // æš—ã„èƒŒæ™¯ãªã‚‰ç™½é»’åè»¢
        if (avgBrightness < 128) {
            for (var i = 0; i < d.length; i += 4) {
                d[i] = 255 - d[i];
                d[i + 1] = 255 - d[i + 1];
                d[i + 2] = 255 - d[i + 2];
            }
        }

        ctx.putImageData(imageData, 0, 0);
        return canvas;
    }

    // ===== OCR =====
    btnOcr.addEventListener('click', runOCR);

    async function runOCR() {
        if (files.length === 0 || isProcessing) return;
        isProcessing = true;
        btnOcr.disabled = true;
        btnCsv.disabled = true;
        progressArea.classList.add('visible');
        progressStatus.textContent = 'OCRã‚¨ãƒ³ã‚¸ãƒ³èª­ã¿è¾¼ã¿ä¸­...';
        progressFill.style.width = '0%';
        totalImages = files.length;
        currentImageIndex = 0;

        try {
            var worker = await Tesseract.createWorker('jpn+eng', 1, {
                logger: function(m) {
                    if (m.status === 'loading tesseract core') {
                        progressStatus.textContent = 'OCRã‚¨ãƒ³ã‚¸ãƒ³èª­ã¿è¾¼ã¿ä¸­...';
                    } else if (m.status === 'loading language traineddata') {
                        progressStatus.textContent = 'è¨€èªãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­... ' + Math.round(m.progress * 100) + '%';
                        progressFill.style.width = Math.round(m.progress * 15) + '%';
                    } else if (m.status === 'initializing api') {
                        progressStatus.textContent = 'åˆæœŸåŒ–ä¸­...';
                        progressFill.style.width = '18%';
                    } else if (m.status === 'recognizing text') {
                        var imgPct = Math.round(m.progress * 100);
                        var overall = 20 + ((currentImageIndex + m.progress) / totalImages) * 80;
                        progressStatus.textContent = 'ç”»åƒ ' + (currentImageIndex + 1) + '/' + totalImages + ' ã‚’èªè­˜ä¸­... ' + imgPct + '%';
                        progressFill.style.width = Math.round(overall) + '%';
                    }
                }
            });

            var allText = '';
            for (currentImageIndex = 0; currentImageIndex < files.length; currentImageIndex++) {
                progressStatus.textContent = 'ç”»åƒ ' + (currentImageIndex + 1) + '/' + totalImages + ' ã‚’å‰å‡¦ç†ä¸­...';
                var img = await loadImage(files[currentImageIndex]);
                var processed = preprocessImage(img);
                var result = await worker.recognize(processed);
                allText += result.data.text + '\n';
            }

            await worker.terminate();
            progressFill.style.width = '100%';
            progressStatus.textContent = 'å®Œäº†';

            rawText = allText;
            parsedResults = correctResults(parseLog(allText));
            displayResults();
        } catch (err) {
            progressStatus.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.message;
            console.error(err);
        }

        isProcessing = false;
        btnOcr.disabled = files.length === 0;
    }

    // ===== ãƒ†ã‚­ã‚¹ãƒˆå¾Œå‡¦ç† & ãƒ‘ãƒ¼ã‚¹ =====
    function postProcess(text) {
        // å…¨è§’â†’åŠè§’æ•°å­—
        text = text.replace(/[ï¼-ï¼™]/g, function(c) {
            return String.fromCharCode(c.charCodeAt(0) - 0xFEE0);
        });
        // æ•°å­—é–“ã®ã‚¹ãƒšãƒ¼ã‚¹é™¤å»ï¼ˆOCRã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆï¼‰
        text = text.replace(/(\d)\s+(\d)/g, '$1$2');
        // æ•°å­—ã®èª¤èªè­˜è£œæ­£
        text = text.replace(/[oOĞ¾Ğ]/g, '0');
        text = text.replace(/[lIï½Œï¼©]/g, '1');
        // æ‹¬å¼§ã®æ­£è¦åŒ–
        text = text.replace(/[ï¼ˆ(]/g, 'ï¼ˆ');
        text = text.replace(/[ï¼‰)]/g, 'ï¼‰');
        // ã€Œã€ã®æ­£è¦åŒ–
        text = text.replace(/[ã€Œï½¢ï¹]/g, 'ã€Œ');
        text = text.replace(/[ã€ï½£ï¹‚]/g, 'ã€');
        return text;
    }

    function parseLog(raw) {
        var text = postProcess(raw);
        var lines = text.split('\n').map(function(l) {
            // OCRãŒæ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆå†…ã«æŒ¿å…¥ã™ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»
            return l.trim().replace(/\s/g, '');
        }).filter(function(l) { return l; });

        // æ­£è¦åŒ–æ¸ˆã¿ã®æ‹¬å¼§ãƒ»å¼•ç”¨ç¬¦ã‚’ä½¿ç”¨
        var reAttack = /^(.+?éšŠ)(?:ï¼ˆ(\d+)ï¼‰)?\s*ãŒæ”»æ’ƒ/;
        var reDamage = /åŸå£ã«(\d+)ã®æå®³(?:ï¼ˆ(ä¼šå¿ƒ|æ’ƒå¿ƒ)ï¼‰)?/;
        var reTactic = /^(.+?éšŠ)ï¼ˆ(\d+)ï¼‰\s*ã®(.+?)ãŒæˆ¦æ³•ã€Œ(.+?)ã€ã‚’ç™ºå‹•/;
        var reChain = /^ç¶šã‘ã¦(.+?)ãŒæˆ¦æ³•ã€Œ(.+?)ã€ã‚’ç™ºå‹•/;
        var reOtherPlayer = /ã®.+?éšŠã®.+?ãŒæˆ¦æ³•/;

        var results = [];
        var currentUnit = '';
        var currentTroops = '';
        var currentCaster = '';
        var currentTactic = '';
        var isTacticActive = false;

        for (var idx = 0; idx < lines.length; idx++) {
            var line = lines[idx];
            var m;

            // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
            if (reOtherPlayer.test(line)) continue;

            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: æˆ¦æ³•ç™ºå‹•ï¼ˆæ”»æ’ƒã‚ˆã‚Šå…ˆã«åˆ¤å®šï¼‰
            m = reTactic.exec(line);
            if (m) {
                currentUnit = m[1];
                currentTroops = m[2];
                currentCaster = m[3];
                currentTactic = m[4];
                isTacticActive = true;
                continue;
            }

            // ãƒ‘ã‚¿ãƒ¼ãƒ³4: é€£é–æˆ¦æ³•
            m = reChain.exec(line);
            if (m) {
                currentCaster = m[1];
                currentTactic = m[2];
                // éƒ¨éšŠåãƒ»å…µåŠ›ã¯ç›´å‰ã®æˆ¦æ³•è¡Œã‚’å¼•ãç¶™ã
                continue;
            }

            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: é€šå¸¸æ”»æ’ƒã®é–‹å§‹
            m = reAttack.exec(line);
            if (m) {
                // ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ”»æ’ƒã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ"â—‹â—‹ã®â—‹â—‹éšŠ"ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
                if (/ã®.+éšŠ$/.test(m[1])) continue;
                currentUnit = m[1];
                currentTroops = m[2] || '';
                currentCaster = '';
                currentTactic = '';
                isTacticActive = false;
                continue;
            }

            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ãƒ€ãƒ¡ãƒ¼ã‚¸è¡Œï¼ˆåŸå£ã®ã¿ï¼‰
            m = reDamage.exec(line);
            if (m) {
                var damageVal = m[1];
                var modifier = m[2] || '';

                // æ‹¬å¼§å½¢å¼ã§å–ã‚Œãªãã¦ã‚‚è¡Œå†…ã«ä¼šå¿ƒ/æ’ƒå¿ƒãŒã‚ã‚Œã°æ¤œå‡º
                if (!modifier) {
                    if (line.indexOf('ä¼šå¿ƒ') !== -1) modifier = 'ä¼šå¿ƒ';
                    else if (line.indexOf('æ’ƒå¿ƒ') !== -1) modifier = 'æ’ƒå¿ƒ';
                }
                // æ¬¡ã®è¡ŒãŒä¼šå¿ƒ/æ’ƒå¿ƒã®å˜ç‹¬è¡Œã®å ´åˆã‚‚æ¤œå‡º
                if (!modifier && idx + 1 < lines.length) {
                    var nextLine = lines[idx + 1];
                    if (nextLine.indexOf('ä¼šå¿ƒ') !== -1 && nextLine.length < 10) { modifier = 'ä¼šå¿ƒ'; idx++; }
                    else if (nextLine.indexOf('æ’ƒå¿ƒ') !== -1 && nextLine.length < 10) { modifier = 'æ’ƒå¿ƒ'; idx++; }
                }

                var type;
                if (modifier) {
                    type = modifier;
                } else if (isTacticActive) {
                    type = 'æˆ¦æ³•';
                } else {
                    type = 'é€šå¸¸';
                }
                results.push({
                    unit: currentUnit,
                    troops: currentTroops,
                    target: 'åŸå£',
                    damage: damageVal,
                    type: type,
                    caster: isTacticActive ? currentCaster : '',
                    tactic: isTacticActive ? currentTactic : ''
                });
                continue;
            }
        }

        return results;
    }

    // ===== çµæœè¡¨ç¤º =====
    function displayResults() {
        // ç”Ÿãƒ†ã‚­ã‚¹ãƒˆ
        rawTextSection.style.display = 'block';
        rawTextContent.textContent = rawText;

        // ãƒ†ãƒ¼ãƒ–ãƒ«
        resultsBody.innerHTML = '';
        resultsArea.style.display = 'block';

        if (parsedResults.length > 0) {
            parsedResults.forEach(function(r, rowIdx) {
                var tr = document.createElement('tr');

                // ç·¨é›†å¯èƒ½ã‚»ãƒ«ç”Ÿæˆ
                var cells = [
                    { html: correctedCell(r.unit, r._origUnit), cls: 'editable' },
                    { html: esc(r.troops), cls: 'num editable' },
                    { html: esc(r.target), cls: 'editable' },
                    { html: Number(r.damage || 0).toLocaleString(), cls: 'num editable' },
                    { html: '<span class="type-badge type-' + r.type + '">' + r.type + '</span>', cls: 'editable' },
                    { html: correctedCell(r.caster, r._origCaster), cls: 'editable' },
                    { html: correctedCell(r.tactic, r._origTactic), cls: 'editable' }
                ];

                cells.forEach(function(cell, colIdx) {
                    var td = document.createElement('td');
                    td.className = cell.cls;
                    td.innerHTML = cell.html;
                    td.addEventListener('dblclick', function() { startEdit(td, rowIdx, colIdx); });
                    tr.appendChild(td);
                });

                // å‰Šé™¤ãƒœã‚¿ãƒ³
                var delTd = document.createElement('td');
                delTd.className = 'col-del';
                var delBtn = document.createElement('button');
                delBtn.className = 'row-delete';
                delBtn.textContent = '\u2715';
                delBtn.title = 'è¡Œã‚’å‰Šé™¤';
                delBtn.addEventListener('click', function() { deleteRow(rowIdx); });
                delTd.appendChild(delBtn);
                tr.appendChild(delTd);

                resultsBody.appendChild(tr);
            });

            updateSummary();
            btnCsv.disabled = false;
        } else {
            resultsBody.innerHTML = '<tr><td colspan="8" class="no-data">åŸå£ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</td></tr>';
            summary.innerHTML = '';
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º
        setTimeout(function() { progressArea.classList.remove('visible'); }, 1000);
    }

    function esc(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // è£œæ­£ã•ã‚ŒãŸã‚»ãƒ«ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ä»˜ããƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¡¨ç¤º
    function correctedCell(value, orig) {
        if (!orig) return esc(value);
        return '<span class="corrected" title="OCR: ' + esc(orig) + '">' + esc(value) + '</span>';
    }

    // ===== ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›† =====
    var FIELD_MAP = ['unit', 'troops', 'target', 'damage', 'type', 'caster', 'tactic'];

    function startEdit(td, rowIdx, colIdx) {
        if (td.querySelector('.cell-input')) return; // ç·¨é›†ä¸­
        var field = FIELD_MAP[colIdx];
        var r = parsedResults[rowIdx];
        var val = r[field] || '';
        var isNum = colIdx === 1 || colIdx === 3; // troops, damage
        var input = document.createElement('input');
        input.className = 'cell-input' + (isNum ? ' num' : '');
        input.value = val;
        td.textContent = '';
        td.appendChild(input);
        input.focus();
        input.select();

        function commit() {
            var newVal = input.value.trim();
            r[field] = newVal;
            // è£œæ­£ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ‰‹å‹•ç·¨é›†ã—ãŸã‚‰ã‚‚ã†è£œæ­£ãƒãƒ¼ã‚¯ã¯ä¸è¦ï¼‰
            delete r['_orig' + field.charAt(0).toUpperCase() + field.slice(1)];
            displayResults();
        }
        input.addEventListener('blur', commit);
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); commit(); }
            if (e.key === 'Escape') { e.preventDefault(); displayResults(); }
        });
    }

    function deleteRow(rowIdx) {
        parsedResults.splice(rowIdx, 1);
        displayResults();
    }

    function updateSummary() {
        if (parsedResults.length === 0) {
            summary.innerHTML = '';
            btnCsv.disabled = true;
            return;
        }
        var totalDamage = parsedResults.reduce(function(sum, r) { return sum + Number(r.damage || 0); }, 0);
        var correctedCount = parsedResults.filter(function(r) { return r._origUnit || r._origCaster || r._origTactic; }).length;
        summary.innerHTML =
            '<div><span class="summary-label">åˆè¨ˆæå®³:</span><span class="summary-value">' + totalDamage.toLocaleString() + '</span></div>' +
            '<div><span class="summary-label">æŠ½å‡ºè¡Œæ•°:</span><span class="summary-value">' + parsedResults.length + '</span></div>' +
            (correctedCount > 0 ? '<div><span class="summary-label">è¾æ›¸è£œæ­£:</span><span class="summary-value">' + correctedCount + 'è¡Œ</span></div>' : '');
    }

    // ===== ç”Ÿãƒ†ã‚­ã‚¹ãƒˆãƒˆã‚°ãƒ« =====
    rawTextToggle.addEventListener('click', function() {
        var content = rawTextContent;
        if (content.classList.contains('visible')) {
            content.classList.remove('visible');
            rawTextToggle.textContent = 'â–¶ OCRç”Ÿãƒ†ã‚­ã‚¹ãƒˆ';
        } else {
            content.classList.add('visible');
            rawTextToggle.textContent = 'â–¼ OCRç”Ÿãƒ†ã‚­ã‚¹ãƒˆ';
        }
    });

    // ===== CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ =====
    btnCsv.addEventListener('click', function() {
        if (parsedResults.length === 0) return;

        var header = 'éƒ¨éšŠå,å…µåŠ›,å¯¾è±¡,æå®³å€¤,ç¨®åˆ¥,ç™ºå‹•è€…,æˆ¦æ³•å';
        var rows = parsedResults.map(function(r) {
            return [r.unit, r.troops, r.target, r.damage, r.type, r.caster, r.tactic].join(',');
        });
        var csv = header + '\n' + rows.join('\n');

        // BOMä»˜ãã§Excelå¯¾å¿œ
        var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
        var url = URL.createObjectURL(blob);

        var now = new Date();
        var pad = function(n) { return String(n).padStart(2, '0'); };
        var filename = 'damage-log_' +
            now.getFullYear() + pad(now.getMonth() + 1) + pad(now.getDate()) + '_' +
            pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds()) + '.csv';

        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    });
})();
</script>
</body>
</html>
